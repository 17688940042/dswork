<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC
	"-//ibatis.apache.org//DTD Mapper 3.0//EN" 
	"http://ibatis.apache.org/dtd/ibatis-3-mapper.dtd">

<mapper namespace="dswork.common.dao.DsCommonDao">

<resultMap id="resultFlow" type="dswork.common.model.IFlow">
	<id property="id" column="ID" />
	<result property="deployid" column="DEPLOYID" />
	<result property="name" column="NAME" />
</resultMap>
<select id="selectFlow" resultMap="resultFlow">
	select f2.ID, f2.DEPLOYID, f2.NAME from DS_FLOW f1
	left join DS_FLOW f2 on f2.DEPLOYID=f1.DEPLOYID and f2.VNUM&gt;0
	where f1.STATUS=1 and f1.VNUM=0 and f1.ALIAS=#{alias}
</select>


<insert id="insertFlowPi" parameterType="dswork.common.model.IFlowPi">
	<selectKey resultType="Long" order="AFTER" keyProperty="id">
		select LAST_INSERT_ID()
	</selectKey>
	insert into DS_FLOW_PI
	(ID, YWLSH, ALIAS, FLOWID, DEPLOYID, PIDAY, PIDAYTYPE, PISTART, PIEND, PIUPSTART, PIUPEND, STATUS, CACCOUNT, CNAME, PIALIAS)
	values
	(null, #{ywlsh}, #{alias}, #{flowid}, #{deployid}, #{piday}, #{pidaytype}, #{pistart},
		<if test="@Ognl@isEmpty(piend)">null</if><if test="@Ognl@isNotEmpty(piend)">#{piend}</if>,
		#{piupstart}, #{piupend}, #{status}, #{caccount}, #{cname}, #{pialias})
</insert>
<update id="updateFlowPi">
	update DS_FLOW_PI set STATUS=#{status}, PIALIAS=#{pialias} where ID=#{id}
</update>


<resultMap id="resultFlowTask" type="dswork.common.model.IFlowTask">
	<id property="id" column="ID" />
	<result property="flowid" column="FLOWID" />
	<result property="deployid" column="DEPLOYID" />
	<result property="talias" column="TALIAS" />
	<result property="tname" column="TNAME" />
	<result property="tcount" column="TCOUNT" />
	<result property="tnext" column="TNEXT" />
	<result property="tusers" column="TUSERS" />
	<result property="tmemo" column="TMEMO" />
</resultMap>
<select id="selectFlowTask" resultMap="resultFlowTask">
	select ID, FLOWID, DEPLOYID, TALIAS, TNAME, TCOUNT, TNEXT, TUSERS, TMEMO
	from DS_FLOW_TASK where FLOWID=#{flowid} and TALIAS=#{talias}
</select>
<select id="queryFlowTask" resultMap="resultFlowTask">
	select ID, FLOWID, DEPLOYID, TALIAS, TNAME, TCOUNT, TNEXT, TUSERS, TMEMO
	from DS_FLOW_TASK where FLOWID=#{flowid}
</select>


<insert id="insertFlowPiData" parameterType="dswork.common.model.IFlowPiData">
	<selectKey resultType="Long" order="AFTER" keyProperty="id">
		select LAST_INSERT_ID()
	</selectKey>
	insert into DS_FLOW_PI_DATA
	(ID, PIID, TALIAS, TNAME, STATUS, PACCOUNT, PNAME, PTIME, PTYPE, MEMO)
	values
	(null, #{piid}, #{talias}, #{tname}, #{status}, #{paccount}, #{pname}, #{ptime}, #{ptype}, #{memo})
</insert>


<sql id="sqlFlowWaiting">
	ID, PIID, YWLSH, FLOWID, FLOWNAME, TALIAS, TNAME, TCOUNT, TNEXT, TSTART, TUSER, TUSERS, TMEMO, TINTERFACE
</sql>
<insert id="insertFlowWaiting" parameterType="dswork.common.model.IFlowWaiting">
	<selectKey resultType="Long" order="AFTER" keyProperty="id">
		select LAST_INSERT_ID()
	</selectKey>
	insert into DS_FLOW_PI_WAITING
	(<include refid="sqlFlowWaiting" />)
	values
	(null, #{piid}, #{ywlsh}, #{flowid}, #{flowname}, #{talias}, #{tname}, #{tcount}, #{tnext}, #{tstart},
		<if test="@Ognl@isEmpty(tuser)">null</if><if test="@Ognl@isNotEmpty(tuser)">#{tuser}</if>,
		<if test="@Ognl@isEmpty(tusers)">null</if><if test="@Ognl@isNotEmpty(tusers)">#{tusers}</if>,
		#{tmemo}, #{tinterface})
</insert>
<delete id="deleteFlowWaiting">
	delete from DS_FLOW_PI_WAITING where ID=#{id}
</delete>
<delete id="deleteFlowWaitingByPiid">
	delete from DS_FLOW_PI_WAITING where PIID=#{piid}
</delete>
<update id="updateFlowWaiting">
	update DS_FLOW_PI_WAITING set TCOUNT=TCOUNT-1, TSTART=#{tstart}
	where ID=#{id} and TCOUNT&gt;1
</update>
<update id="updateFlowWaitingUser">
	update DS_FLOW_PI_WAITING set TUSER=#{tuser}, TUSERS=null where ID=#{id}
</update>
<resultMap id="resultFlowWaiting" type="dswork.common.model.IFlowWaiting">
	<id property="id" column="ID" />
	<result property="piid" column="PIID" />
	<result property="ywlsh" column="YWLSH" />
	<result property="flowid" column="FLOWID" />
	<result property="flowname" column="FLOWNAME" />
	<result property="talias" column="TALIAS" />
	<result property="tname" column="TNAME" />
	<result property="tcount" column="TCOUNT" />
	<result property="tnext" column="TNEXT" />
	<result property="tstart" column="TSTART" />
	<result property="tuser" column="TUSER" />
	<result property="tusers" column="TUSERS" />
	<result property="tmemo" column="TMEMO" />
	<result property="tinterface" column="TINTERFACE" />
</resultMap>
<select id="selectFlowWaiting" resultMap="resultFlowWaiting">
	select <include refid="sqlFlowWaiting" /> from DS_FLOW_PI_WAITING where ID=#{id}
</select>
<select id="selectFlowWaitingByPiid" resultMap="resultFlowWaiting">
	select <include refid="sqlFlowWaiting" /> from DS_FLOW_PI_WAITING
	where PIID=#{piid} <if test="@Ognl@isNotEmpty(talias)"> and TALIAS=#{talias}</if>
</select>
<select id="queryFlowWaitingTalias" resultType="java.lang.String">
	select TALIAS from DS_FLOW_PI_WAITING where PIID=#{piid}
</select>
<select id="queryFlowWaiting" resultMap="resultFlowWaiting">
	select <include refid="sqlFlowWaiting" /> from DS_FLOW_PI_WAITING
	where (TUSER=#{account} or TUSERS like concat('%', #{account}, '%')) and TCOUNT=1
</select>

</mapper>
